PROCEDURE POST

CLEAR
CLOSE ALL
SET DATE brit
SET CENT ON
IF _DOS
 SET COLOR TO 7/1
ENDIF

SELECT 1

CLEAR

USE st-tran
SORT ON DOC_TYPE, DOC_NO, SR_NO TO abc
USE

SELECT 1
USE abc
COPY TO st-tran

*RUN del abc.dbf

SELECT 1
USE st-tran
INDEX ON DATE TO stdate.IDX
SELECT 2
USE p-order
INDEX ON STR(ORDER_NO,5)+STR(C1,2)+STR(C2,2)+STR(C3,3)+STR(I1,2)+STR(I2,2)+STR(I3,4) TO ordidx.IDX
SELECT 3
USE item-bal
INDEX ON STR(LOC_CODE,4)+STR(I1,2)+STR(I2,2)+STR(I3,4) TO itm-bal.IDX
SELECT 4
USE stock
SELECT 5
USE s-order
INDEX ON STR(ORDER_NO,5)+STR(C1,2)+STR(C2,2)+STR(C3,3)+STR(I1,2)+STR(I2,2)+STR(I3,4) TO sordidx.IDX
SELECT 1
GOTO BOTTOM
STORE DATE TO MDATE, MPDATE
@ 1, 2 SAY 'Post Transactions To Ledger:'
@ 3, 2 SAY 'This option will post all un-posted transactions to their respective'
@ 4, 2 SAY 'ledger heads Upto Given Date....'
@ 13, 14 SAY 'Transactions upto            exist in file '
SET COLOR TO *+g
@ 13, 32 SAY MDATE
SET COLOR TO 7/1     
@ 14, 14 SAY 'Date upto which you want transactions to be posted ' GET MPDATE
READ
P= ' '
DO WHILE .not. P$'CQ'
   @ 23, 50 SAY 'Continue/Quit  -  C/Q  ' GET P FUNCTION '!'
   READ
ENDDO
IF P='Q'
   CLOSE ALL
   CLEAR
   RETURN
ENDIF
CLEAR
@ 12, 23 SAY 'Press any key to start posting'
WAIT ''
CLEAR
@ 13, 23 SAY 'Please wait data is being posted....'
SELECT 1
CNT= 0
GOTO TOP
SET FILTER TO FLAG=' '.and.DATE<=MPDATE
GOTO TOP
MSR_NO= 0
DO WHILE .not. EOF()
   MDATE= DATE
   MDOC_NO= DOC_NO
   MDOC_TYPE= DOC_TYPE
   MLOC_CODE= LOC_CODE
   MORDER_NO= ORDER_NO
   MDEPT_CODE= DEPT_CODE
   MCITY_CODE= CITY_CODE
   MZONE_CODE= ZONE_CODE
   MI1= I1
   MI2= I2
   MI3= I3
   MC1= C_C1
   MC2= C_C2
   MC3= C_C3
   MD1= D_D1
   MD2= D_D2
   MD3= D_D3
   MQTY= T_QTY
   MRATE= RATE
   MAMOUNT= T_AMOUNT
   MPSR_UPRIC= PSR_UPRICE
   MPSR_TPRIC= PSR_TPRICE
   MF_T= F_T
   IF MDOC_TYPE=1
      STORE STR(MLOC_CODE,4)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO XYZ
      SELECT 3
      SEEK XYZ
      IF FOUND()
         VAL_TOT= 0
         VAL_TOT= QTY*AVG_PRICE
         MTOT_QTY= 0
         MTOT_QTY= QTY+MQTY
         MVAL_TOT= 0
         MVAL_TOT= VAL_TOT+MAMOUNT
         MAVG= 0
         IF MTOT_QTY<>0
            MAVG= MVAL_TOT/MTOT_QTY
         ENDIF
         REPLACE QTY WITH MTOT_QTY
         REPLACE AVG_PRICE WITH MAVG
         MSR_NO= SR_NO+1
         REPLACE SR_NO WITH MSR_NO
      ENDIF
      SELECT 4
      APPEND BLANK
      REPLACE DOC_NO WITH MDOC_NO, DOC_TYPE WITH 1, DATE WITH MDATE, LOC_CODE WITH MLOC_CODE
      REPLACE C_C1 WITH MC1, C_C2 WITH MC2, C_C3 WITH MC3, T_QTY WITH MQTY
      REPLACE I1 WITH MI1, I2 WITH MI2, I3 WITH MI3, RATE WITH MRATE, T_AMOUNT WITH MAMOUNT
      REPLACE AVG_PRICE WITH MAVG, SR_NO WITH MSR_NO, QTY_BAL WITH MTOT_QTY
      REPLACE PSR_UPRICE WITH MPSR_UPRIC, PSR_TPRICE WITH MPSR_TPRIC
      SELECT 2
      STORE STR(MORDER_NO,5)+STR(MC1,2)+STR(MC2,2)+STR(MC3,3)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO ORD
      SEEK ORD
      IF FOUND()
         MORD_DEL= 0
         MORD_DEL= QTY_DEL+MQTY
         MORDBAL= 0
         MORDBAL= QTY_ORD-MORD_DEL
         REPLACE QTY_BAL WITH MORDBAL, QTY_DEL WITH MORD_DEL
      ENDIF
   ENDIF
   IF MDOC_TYPE=2
      STORE STR(MLOC_CODE,4)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO XYZ
      SELECT 3
      SEEK XYZ
      IF FOUND()
         MTOT_QTY= 0
         MTOT_QTY= QTY-MQTY
         MAVG= AVG_PRICE
         REPLACE QTY WITH MTOT_QTY
         MSR_NO= SR_NO+1
         REPLACE SR_NO WITH MSR_NO
      ENDIF
      SELECT 4
      APPEND BLANK
      REPLACE DOC_NO WITH MDOC_NO, DOC_TYPE WITH 2, DATE WITH MDATE, LOC_CODE WITH MLOC_CODE
      REPLACE D_D1 WITH MD1, D_D2 WITH MD2, D_D3 WITH MD3, T_QTY WITH MQTY
      REPLACE I1 WITH MI1, I2 WITH MI2, I3 WITH MI3, RATE WITH MAVG, T_AMOUNT WITH MQTY*MAVG
      REPLACE AVG_PRICE WITH MAVG, SR_NO WITH MSR_NO, QTY_BAL WITH MTOT_QTY
      REPLACE PSR_UPRICE WITH MPSR_UPRIC, PSR_TPRICE WITH MPSR_TPRIC
      SELECT 2
      STORE STR(MORDER_NO,5)+STR(MC1,2)+STR(MC2,2)+STR(MC3,3)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO ORD
      SEEK ORD
      IF FOUND()
         MORD_DEL= 0
         MORD_DEL= QTY_DEL+MQTY
         MORDBAL= 0
         MORDBAL= QTY_ORD-MORD_DEL
         REPLACE QTY_BAL WITH MORDBAL, QTY_DEL WITH MORD_DEL
      ENDIF
   ENDIF
   IF MDOC_TYPE=3
      STORE STR(MLOC_CODE,4)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO XYZ
      SELECT 3
      SEEK XYZ
      IF FOUND()
         MTOT_QTY= 0
         MTOT_QTY= QTY-MQTY
         MAVG= AVG_PRICE
         REPLACE QTY WITH MTOT_QTY
         MSR_NO= SR_NO+1
         REPLACE SR_NO WITH MSR_NO
      ENDIF
      SELECT 4
      APPEND BLANK
      REPLACE DOC_NO WITH MDOC_NO, DOC_TYPE WITH 3, DATE WITH MDATE
      REPLACE LOC_CODE WITH MLOC_CODE, T_QTY WITH MQTY
      REPLACE I1 WITH MI1, I2 WITH MI2, I3 WITH MI3, SR_NO WITH MSR_NO
      REPLACE DEPT_CODE WITH MDEPT_CODE, RATE WITH MAVG, T_AMOUNT WITH MQTY*MAVG
      REPLACE AVG_PRICE WITH MAVG, QTY_BAL WITH MTOT_QTY
   ENDIF
   IF MDOC_TYPE=4
      STORE STR(MLOC_CODE,4)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO XYZ
      SELECT 3
      SEEK XYZ
      IF FOUND()
         MTOT_QTY= 0
         MTOT_QTY= QTY+MQTY
         MAVG= AVG_PRICE
         REPLACE QTY WITH MTOT_QTY
         MSR_NO= SR_NO+1
         REPLACE SR_NO WITH MSR_NO
      ENDIF
      SELECT 4
      APPEND BLANK
      REPLACE DOC_NO WITH MDOC_NO, DOC_TYPE WITH 4, DATE WITH MDATE
      REPLACE LOC_CODE WITH MLOC_CODE, T_QTY WITH MQTY
      REPLACE I1 WITH MI1, I2 WITH MI2, I3 WITH MI3, SR_NO WITH MSR_NO
      REPLACE DEPT_CODE WITH MDEPT_CODE, RATE WITH MAVG, T_AMOUNT WITH MQTY*MAVG
      REPLACE AVG_PRICE WITH MAVG, QTY_BAL WITH MTOT_QTY
   ENDIF
   IF MDOC_TYPE=5
      STORE STR(MLOC_CODE,4)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO XYZ
      SELECT 3
      SEEK XYZ
      IF FOUND()
         MTOT_QTY= 0
         MTOT_QTY= QTY+MQTY
         MAVG= AVG_PRICE
         REPLACE QTY WITH MTOT_QTY
         MSR_NO= SR_NO+1
         REPLACE SR_NO WITH MSR_NO
      ENDIF
      SELECT 4
      APPEND BLANK
      REPLACE DOC_NO WITH MDOC_NO, DOC_TYPE WITH 5, DATE WITH MDATE
      REPLACE LOC_CODE WITH MLOC_CODE, T_QTY WITH MQTY, SR_NO WITH MSR_NO
      REPLACE I1 WITH MI1, I2 WITH MI2, I3 WITH MI3, DEPT_CODE WITH MDEPT_CODE
      REPLACE AVG_PRICE WITH MAVG, QTY_BAL WITH MTOT_QTY
   ENDIF
   IF MDOC_TYPE=6
      STORE STR(MLOC_CODE,4)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO XYZ
      SELECT 3
      SEEK XYZ
      IF FOUND()
         MTOT_QTY= 0
         MTOT_QTY= QTY-MQTY
         MAVG= AVG_PRICE
         REPLACE QTY WITH MTOT_QTY
         MSR_NO= SR_NO+1
         REPLACE SR_NO WITH MSR_NO
      ENDIF
      SELECT 4
      APPEND BLANK
      REPLACE DOC_NO WITH MDOC_NO, DOC_TYPE WITH 6, DATE WITH MDATE, LOC_CODE WITH MLOC_CODE
      REPLACE D_D1 WITH MD1, D_D2 WITH MD2, D_D3 WITH MD3, T_QTY WITH MQTY
      REPLACE I1 WITH MI1, I2 WITH MI2, I3 WITH MI3, RATE WITH MAVG, T_AMOUNT WITH MQTY*MAVG
      REPLACE AVG_PRICE WITH MAVG, SR_NO WITH MSR_NO, QTY_BAL WITH MTOT_QTY
      REPLACE PSR_UPRICE WITH MPSR_UPRIC, PSR_TPRICE WITH MPSR_TPRIC
      REPLACE CITY_CODE WITH MCITY_CODE, ZONE_CODE WITH MZONE_CODE
      SELECT 5
      STORE STR(MORDER_NO,5)+STR(MC1,2)+STR(MC2,2)+STR(MC3,3)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO ORD
      SEEK ORD
      IF FOUND()
         MORD_DEL= 0
         MORD_DEL= QTY_DEL+MQTY
         MORDBAL= 0
         MORDBAL= QTY_ORD-MORD_DEL
         REPLACE QTY_BAL WITH MORDBAL, QTY_DEL WITH MORD_DEL
      ENDIF
   ENDIF
   IF MDOC_TYPE=7
      STORE STR(MLOC_CODE,4)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO XYZ
      SELECT 3
      SEEK XYZ
      IF FOUND()
         MTOT_QTY= 0
         MTOT_QTY= QTY+MQTY
         MAVG= AVG_PRICE
         REPLACE QTY WITH MTOT_QTY
         MSR_NO= SR_NO+1
         REPLACE SR_NO WITH MSR_NO
      ENDIF
      SELECT 4
      APPEND BLANK
      REPLACE DOC_NO WITH MDOC_NO, DOC_TYPE WITH 7, DATE WITH MDATE, LOC_CODE WITH MLOC_CODE
      REPLACE C_C1 WITH MC1, C_C2 WITH MC2, C_C3 WITH MC3, T_QTY WITH MQTY
      REPLACE I1 WITH MI1, I2 WITH MI2, I3 WITH MI3, RATE WITH MAVG, T_AMOUNT WITH MQTY*MAVG
      REPLACE AVG_PRICE WITH MAVG, SR_NO WITH MSR_NO, QTY_BAL WITH MTOT_QTY
      REPLACE PSR_UPRICE WITH MPSR_UPRIC, PSR_TPRICE WITH MPSR_TPRIC
      SELECT 5
      STORE STR(MORDER_NO,5)+STR(MC1,2)+STR(MC2,2)+STR(MC3,3)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO ORD
      SEEK ORD
      IF FOUND()
         MORD_DEL= 0
         MORD_DEL= QTY_DEL+MQTY
         MORDBAL= 0
         MORDBAL= QTY_ORD+MORD_DEL
         REPLACE QTY_BAL WITH MORDBAL, QTY_DEL WITH MORD_DEL
      ENDIF
   ENDIF
   IF MDOC_TYPE=8
      IF MF_T='F'
         STORE STR(MLOC_CODE,4)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO XYZ
         SELECT 3
         SEEK XYZ
         IF FOUND()
            MTOT_QTY= 0
            MTOT_QTY= QTY-MQTY
            MAVG= AVG_PRICE
            REPLACE QTY WITH MTOT_QTY
            MSR_NO= SR_NO+1
            REPLACE SR_NO WITH MSR_NO
            SELECT 4
            APPEND BLANK
            REPLACE DOC_NO WITH MDOC_NO, DOC_TYPE WITH 8, DATE WITH MDATE
            REPLACE LOC_CODE WITH MLOC_CODE, T_QTY WITH MQTY, SR_NO WITH MSR_NO
            REPLACE I1 WITH MI1, I2 WITH MI2, I3 WITH MI3, F_T WITH 'F'
            REPLACE QTY_BAL WITH MTOT_QTY, AVG_PRICE WITH MAVG
         ENDIF
      ENDIF
      IF MF_T='T'
         STORE STR(MLOC_CODE,4)+STR(MI1,2)+STR(MI2,2)+STR(MI3,4) TO XYZ
         SELECT 3
         SEEK XYZ
         IF FOUND()
            MTOT_QTY= 0
            MTOT_QTY= QTY+MQTY
            MAVG= AVG_PRICE
            REPLACE QTY WITH MTOT_QTY
            MSR_NO= SR_NO+1
            REPLACE SR_NO WITH MSR_NO
            SELECT 4
            APPEND BLANK
            REPLACE DOC_NO WITH MDOC_NO, DOC_TYPE WITH 8, DATE WITH MDATE
            REPLACE LOC_CODE WITH MLOC_CODE, T_QTY WITH MQTY, SR_NO WITH MSR_NO
            REPLACE I1 WITH MI1, I2 WITH MI2, I3 WITH MI3, F_T WITH 'T'
            REPLACE QTY_BAL WITH MTOT_QTY, AVG_PRICE WITH MAVG
         ENDIF
      ENDIF
   ENDIF
   SELECT 1
   REPLACE FLAG WITH 'Y'
   IF .not. EOF()
      SKIP
   ENDIF
ENDDO
CLEAR
CLOSE ALL
USE stock
INDEX ON STR(I1,2)+STR(I2,2)+STR(I3,4) TO itemidx
INDEX ON DTOC(DATE)+STR(DOC_NO,7) TO itemidx1
INDEX ON DOC_NO TO itemidx2
INDEX ON DATE TO stk-idx
CLOSE ALL
RETURN
